<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.everwing.coreservice.wy.dao.mapper.configuration.bc.collection.TBcCollectionMapper" >    <resultMap type="TBcCollectionTotal" id="BaseResultMap">		<result property="id" 					column="id"					jdbcType="VARCHAR"/>		<result property="projectId" 			column="project_id"			jdbcType="VARCHAR"/>		<result property="collectionType" 		column="collection_type"	jdbcType="TINYINT"/>		<result property="familyCount" 			column="family_count"		jdbcType="INTEGER"/>		<result property="totalAmount" 			column="total_amount"		jdbcType="DOUBLE"/>		<result property="completeCount" 		column="complete_count"		jdbcType="INTEGER"/>		<result property="completeAmount" 		column="complete_amount"	jdbcType="DOUBLE"/>		<result property="collectionStatus" 	column="collection_status"	jdbcType="TINYINT"/>		<result property="collectionTime" 		column="collection_time"	jdbcType="TIMESTAMP"/>		<result property="backTime" 			column="back_time"			jdbcType="TIMESTAMP"/>		<result property="createId" 			column="create_id"			jdbcType="VARCHAR"/>		<result property="createTime" 			column="create_time"		jdbcType="TIMESTAMP"/>		<result property="modifyId" 			column="modify_id"			jdbcType="VARCHAR"/>		<result property="modifyTime" 			column="modify_time"		jdbcType="TIMESTAMP"/>		<result property="isWaitBack"			column="is_wait_back"		jdbcType="VARCHAR"/>	</resultMap>	<resultMap id="TBcCillectionName" type="com.everwing.coreservice.common.wy.entity.cust.person.TBcCillectionName" extends="BaseResultMap">		<result column=" backName" property="backName" jdbcType="VARCHAR" />		<result column=" registerPhone" property="registerPhone" jdbcType="VARCHAR" />		<result column=" phone" property="phone" jdbcType="VARCHAR" />	</resultMap>		<sql id="replaceSql">		<![CDATA[		CASE collection_status 					WHEN 0 THEN CONCAT(CONCAT("<a href='javascript:void(0)' name='",id,"' ng-click=\"collection(\'",id,"\',\'",collectionType,"\')\">","托收</a>")) 					WHEN 1 THEN CONCAT(CONCAT("<a href='javascript:void(0)' name='",id,"' ng-click=\"back(\'",id,"\',\'",collectionType,"\')\">","回盘</a>")) 					WHEN 2 THEN CONCAT(CONCAT("<a href='javascript:void(0)' name='",id,"' ng-click=\"complete(\'",id,"\',\'",collectionType,"\')\">","完成</a>"))				    ELSE "" END ,""		]]>	</sql>		<sql id="sql_update">		<set>			<if test="null != projectId"> project_id = #{projectId}, </if>			<if test="null != collectionType"> collection_type = #{collectionType}, </if>			<if test="null != familyCount"> family_count = #{familyCount}, </if>			<if test="null != totalAmount"> total_amount = #{totalAmount}, </if>			<if test="null != completeCount"> complete_count = #{completeCount}, </if>			<if test="null != completeAmount"> complete_amount = #{completeAmount}, </if>			<if test="null != collectionStatus"> collection_status = #{collectionStatus}, </if>			<if test="null != collectionTime"> collection_time = #{collectionTime}, </if>			<if test="null != backTime"> back_time = #{backTime}, </if>			<if test="null != modifyId"> modify_id = #{modifyId}, </if>			<if test="null != isWaitBack"> is_wait_back = #{isWaitBack}, </if>			modify_time = sysdate()		</set>	</sql>		<select id="findIdPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"id" AS "column_name",				MAX(IF(month_str = "01", IFNULL(id,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(id,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(id,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(id,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(id,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(id,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(id,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(id,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(id,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(id,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(id,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(id,0),"")) AS December			FROM 			( 				SELECT id, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findFamilyCountPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"托收户数" AS "column_name",				MAX(IF(month_str = "01", IFNULL(family_count,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(family_count,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(family_count,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(family_count,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(family_count,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(family_count,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(family_count,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(family_count,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(family_count,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(family_count,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(family_count,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(family_count,0),"")) AS December			FROM 			( 				SELECT family_count, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findTotalAmountPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"托收金额" AS "column_name",				MAX(IF(month_str = "01", IFNULL(total_amount,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(total_amount,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(total_amount,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(total_amount,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(total_amount,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(total_amount,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(total_amount,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(total_amount,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(total_amount,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(total_amount,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(total_amount,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(total_amount,0),"")) AS December			FROM 			( 				SELECT total_amount, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findCompleteCountPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"成功托收户数" AS "column_name",				MAX(IF(month_str = "01", IFNULL(complete_count,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(complete_count,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(complete_count,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(complete_count,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(complete_count,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(complete_count,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(complete_count,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(complete_count,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(complete_count,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(complete_count,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(complete_count,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(complete_count,0),"")) AS December			FROM 			( 				SELECT complete_count, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findCompleteAmountPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"成功金额(元)" AS "column_name",				MAX(IF(month_str = "01", IFNULL(complete_amount,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(complete_amount,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(complete_amount,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(complete_amount,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(complete_amount,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(complete_amount,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(complete_amount,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(complete_amount,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(complete_amount,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(complete_amount,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(complete_amount,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(complete_amount,0),"")) AS December			FROM 			( 				SELECT complete_amount, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findNotCompleteAmountPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 				"不成功金额(元)" AS "column_name",				MAX(IF(month_str = "01", IFNULL(not_complete_amount,0),"")) AS January,				MAX(IF(month_str = "02", IFNULL(not_complete_amount,0),"")) AS February,				MAX(IF(month_str = "03", IFNULL(not_complete_amount,0),"")) AS March,				MAX(IF(month_str = "04", IFNULL(not_complete_amount,0),"")) AS April,				MAX(IF(month_str = "05", IFNULL(not_complete_amount,0),"")) AS May,				MAX(IF(month_str = "06", IFNULL(not_complete_amount,0),"")) AS June,				MAX(IF(month_str = "07", IFNULL(not_complete_amount,0),"")) AS July,				MAX(IF(month_str = "08", IFNULL(not_complete_amount,0),"")) AS August,				MAX(IF(month_str = "09", IFNULL(not_complete_amount,0),"")) AS September,				MAX(IF(month_str = "10", IFNULL(not_complete_amount,0),"")) AS October,				MAX(IF(month_str = "11", IFNULL(not_complete_amount,0),"")) AS November,				MAX(IF(month_str = "12", IFNULL(not_complete_amount,0),"")) AS December			FROM 			( 				SELECT (total_amount - complete_amount) as not_complete_amount, DATE_FORMAT(create_time,'%m') AS month_str				FROM t_bc_collection_total				WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}				AND `collection_type` = #{collectionType}				and project_id = #{projectId}				GROUP BY month_str			) t	</select>		<select id="findStatusPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">			SELECT 				"托收状态" AS "column_name",				MAX(IF(month_str = "01", <include refid="replaceSql"/>)) AS January,				MAX(IF(month_str = "02", <include refid="replaceSql"/>)) AS February,				MAX(IF(month_str = "03", <include refid="replaceSql"/>)) AS March,				MAX(IF(month_str = "04", <include refid="replaceSql"/>)) AS April,				MAX(IF(month_str = "05", <include refid="replaceSql"/>)) AS May,				MAX(IF(month_str = "06", <include refid="replaceSql"/>)) AS June,				MAX(IF(month_str = "07", <include refid="replaceSql"/>)) AS July,				MAX(IF(month_str = "08", <include refid="replaceSql"/>)) AS August,				MAX(IF(month_str = "09", <include refid="replaceSql"/>)) AS September,				MAX(IF(month_str = "10", <include refid="replaceSql"/>)) AS October,				MAX(IF(month_str = "11", <include refid="replaceSql"/>)) AS November,				MAX(IF(month_str = "12", <include refid="replaceSql"/>)) AS December				FROM 				( 					SELECT collection_status,id, DATE_FORMAT(create_time,'%m') AS month_str, collection_type as collectionType					FROM t_bc_collection_total					WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}					AND `collection_type` = #{collectionType}					and project_id = #{projectId}					GROUP BY month_str				) t	</select>		<select id="findTotalPerYear" parameterType="TBcCollectionTotal" resultType="java.util.Map">		SELECT 			"总额(元)" AS "column_name",			MAX(IF(month_str = "01", IFNULL(total_amount,0),"")) AS January,			MAX(IF(month_str = "02", IFNULL(total_amount,0),"")) AS February,			MAX(IF(month_str = "03", IFNULL(total_amount,0),"")) AS March,			MAX(IF(month_str = "04", IFNULL(total_amount,0),"")) AS April,			MAX(IF(month_str = "05", IFNULL(total_amount,0),"")) AS May,			MAX(IF(month_str = "06", IFNULL(total_amount,0),"")) AS June,			MAX(IF(month_str = "07", IFNULL(total_amount,0),"")) AS July,			MAX(IF(month_str = "08", IFNULL(total_amount,0),"")) AS August,			MAX(IF(month_str = "09", IFNULL(total_amount,0),"")) AS September,			MAX(IF(month_str = "10", IFNULL(total_amount,0),"")) AS October,			MAX(IF(month_str = "11", IFNULL(total_amount,0),"")) AS November,			MAX(IF(month_str = "12", IFNULL(total_amount,0),"")) AS December		FROM 		( 			SELECT SUM(total_amount) AS total_amount, DATE_FORMAT(create_time,'%m') AS month_str			FROM t_bc_collection_total			WHERE DATE_FORMAT(create_time,'%Y') = #{searchTime}			and project_id = #{projectId}			GROUP BY month_str		) t	</select>		<select id="findById" parameterType="String" resultMap="BaseResultMap">		select * from t_bc_collection_total where id = #{0}	</select>		<select id="findCurrTotal" resultMap="BaseResultMap">		select * from t_bc_collection_total 		 where project_id = #{projectId}		   and collection_type = #{collectionType}		   and DATE_FORMAT(create_time,'%y-%M') = DATE_FORMAT(sysdate(),'%y-%M')		 order by create_time desc		 limit 0,1	</select>		<select id="findRecentTotal" resultMap="BaseResultMap">		select * from t_bc_collection_total 		 where project_id = #{projectId}		   and collection_type = #{collectionType}		 order by create_time desc		 limit 0,1	</select>		<insert id="insert" parameterType="TBcCollectionTotal">		insert into t_bc_collection_total		(			id,			project_id,			collection_type,			family_count,			total_amount,			complete_count,			complete_amount,			collection_status,			collection_time,			back_time,			create_id,			create_time,			modify_id,			modify_time,			is_wait_back		)		values		(			#{id},			#{projectId},			#{collectionType},			#{familyCount},			#{totalAmount},			#{completeCount},			#{completeAmount},			#{collectionStatus},			#{collectionTime},			#{backTime},			#{createId},			#{createTime},			#{modifyId},			#{modifyTime},			#{isWaitBack}		)	</insert>		<update id="update" parameterType="TBcCollectionTotal">		update t_bc_collection_total		<include refid="sql_update"/>		where id = #{id}	</update>		<update id="updateCountAndAmountById">		UPDATE t_bc_collection_total t1 ,				<if test="type == 0">					(   					    SELECT COUNT(tt1.id) AS complete_count ,tt2.total_id 					      FROM t_bc_union_back_body tt1, t_bc_union_back_head tt2					     WHERE tt1.trade_status = '1001' 					       AND tt1.resp_code = '00' 					       AND tt1.head_id = tt2.id					) t2 				</if> 				<if test="type == 1">					(					 SELECT COUNT(tt1.id) AS complete_count ,tt2.total_id 					   FROM t_bc_jrl_body tt1, t_bc_jrl_head tt2					  WHERE tt1.type = 1					    AND  tt1.bank_resp_code = 'FSBR0000'					    AND  tt1.head_id = tt2.id						) t2				</if>		SET t1.collection_status = IF(t1.family_count = t2.complete_count, 2, 1),		    t1.complete_count = (ifnull(t1.complete_count,0) + #{completeCount}),		    t1.complete_amount = (ifnull(t1.complete_amount,0) + #{completeAmount}),		    t1.is_wait_back = "N"		WHERE t1.id = #{id} 		AND t1.id = t2.total_id	</update>		<update id="completeLastTotal">		UPDATE t_bc_collection_total 		   SET collection_status = 2 		 WHERE 1 = 1		 <![CDATA[		 	and DATE_FORMAT(create_time,"%Y-%m") < DATE_FORMAT(CURDATE(),"%Y-%m")		 ]]>	</update>		<select id="findByProjectIdAndTime" resultMap="BaseResultMap">		SELECT * FROM t_bc_Collection_total 		 WHERE project_id = #{projectId}		   AND DATE_FORMAT(collection_time,'%Y-%m') = DATE_FORMAT(#{createTime},'%Y-%m') 	     ORDER BY collection_time DESC 	     LIMIT 1	</select>	<select id="findByTBcClillectionNameByProjectId" resultType="com.everwing.coreservice.common.wy.entity.cust.person.TBcCillectionName">		select t1.card_num AS cardNo,t2.bank_name AS backName,relate_building_code AS buildingCode			from t_bc_collection t1 LEFT JOIN t_bank_info  t2 ON t1.create_bank=t2.id			LEFT JOIN  tc_person_cust t3 ON t1.cust_id=t3.cust_id			WHERE  status=1			  and t1.project_id=#{projectId}	</select>	</mapper>