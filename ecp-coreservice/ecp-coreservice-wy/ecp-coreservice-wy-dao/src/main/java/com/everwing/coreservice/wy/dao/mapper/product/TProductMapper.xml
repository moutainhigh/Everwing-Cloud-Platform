<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.everwing.coreservice.wy.dao.mapper.product.TProductMapper">	<!-- 产品详细 S -->	<resultMap id="TProductDetailResultMap" type="TProductDetail">		<result property="projectId" column="project_id"/>		<result property="batchNo" column="batch_no"/>		<result property="code" column="code"/>		<result property="fieldId" column="field_id"/>		<result property="fieldValue" column="field_value"/>	</resultMap>	<resultMap id="DetailListResultMap" type="TProductDetailList" extends="TProductDetailResultMap">		<result property="fieldName" column="field_name"/>		<result property="attachmentKey" column="attachment_key"/>		<result property="buildingArea" column="building_area"/>		<result property="usableArea" column="usable_area"/>	</resultMap>	<resultMap id="ProductSaleHistoryListResultMap" type="ProductSaleHistoryList">		<result property="orderNo" column="order_batch_no"/>		<result property="buyerName" column="buyer_name"/>		<result property="price" column="price"/>		<result property="quantity" column="quantity"/>		<result property="orderDateTime" column="order_date_time"/>		<result property="buyBeginDate" column="buy_begin_date"/>		<result property="buyEndDate" column="buy_end_date"/>	</resultMap>	<!-- 产品详细 E -->	<!-- 分页查询产品详细 -->	<select id="listPageProductDetail" resultMap="DetailListResultMap" parameterType="TProductDetailSearch">		SELECT			pd.project_id,			pd.batch_no,			pd.`code`		FROM			t_product_detail pd		WHERE			1 = 1			AND pd.field_id LIKE CONCAT(#{productDetailTableId},'%')			<if test="projectId != null and projectId != ''">				AND pd.project_id = #{projectId}			</if>			<if test="batchNo != null and batchNo != ''">				AND pd.batch_no = #{batchNo}			</if>			<if test="code != null and code != ''">				AND pd.code = #{code}			</if>			<if test="fieldValue != null and fieldValue != ''">				AND pd.field_value LIKE CONCAT('%',#{fieldValue},'%')			</if>		GROUP BY			pd.project_id,			pd.batch_no,			pd.`code`	</select>	<!-- 根据条件查询产品详细 -->	<select id="findProductDetailByCondition" resultMap="DetailListResultMap" parameterType="TProductDetailSearch">		SELECT			t.*		FROM		(			SELECT				p.project_id,				p.batch_no,				p.`code`,				p.field_id,				f.field_name,				p.field_value,				f.order_index,				(SELECT b.building_area FROM tc_building b WHERE b.house_code_new = p.field_value)AS building_area,				(SELECT b.usable_area FROM tc_building b WHERE b.house_code_new = p.field_value) AS usable_area			FROM				t_product_detail p,				t_fields f			WHERE				p.field_id = f.id		) t WHERE 1=1		<if test="projectId != null and projectId != ''">			AND t.project_id = #{projectId}		</if>		<if test="batchNo != null and batchNo != ''">			AND t.batch_no = #{batchNo}		</if>		<if test="code != null and code != ''">			AND t.code = #{code}		</if>		<if test="fieldId != null and fieldId != ''">			AND t.field_id = #{fieldId}		</if>		<if test="fieldValue != null and fieldValue != ''">			AND t.batch_no IN			(				SELECT					pd.batch_no				FROM t_product_detail pd				WHERE pd.field_id IN(SELECT f.id FROM t_fields f WHERE f.table_id = #{productDetailTableId})				AND pd.field_value LIKE CONCAT('%',#{fieldValue},'%')			)		</if>		<if test="productCodeList != null">			AND t.code IN			<foreach collection="productCodeList" item="item" index="index" open="(" close=")" separator=",">				'${item}'			</foreach>		</if>		ORDER BY			t.project_id,			t.batch_no,			t.`code`,			t.order_index	</select>	<!-- 分页查询产品销售记录 -->	<select id="listPageProductSaleHistory" resultMap="ProductSaleHistoryListResultMap" parameterType="ProductSaleHistorySearch">		SELECT		    pod.order_batch_no,			(				CASE WHEN (SELECT count(*) FROM tc_person_cust pc WHERE pc.cust_id = po.buyer_id) > 0 THEN					(SELECT pc1.`name` FROM tc_person_cust pc1 WHERE pc1.cust_id = po.buyer_id)				ELSE					(SELECT ec.enterprise_name FROM tc_enterprise_cust ec WHERE ec.enterprise_id = po.buyer_id)				END			)AS buyer_name,			pod.quantity,			pod.order_amount AS price,			po.create_time AS order_date_time,			pod.buy_begin_date,			pod.buy_end_date		FROM		t_product_order_detail pod		LEFT JOIN t_product_order po ON pod.order_batch_no = po.batch_no		WHERE po.status = 'success' AND pod.product_code = #{productCode}		ORDER BY pod.create_time DESC	</select>	<!-- 新增产品明细信息 -->	<insert id="batchInsertProductDetail" parameterType="TProductDetailInsert">		<foreach collection="productDetailList" item="fieldMap" separator=";">			<foreach collection="fieldMap.keys" item="k" separator=";">				INSERT INTO t_product_detail				(				id,				project_id,				batch_no,				code,				field_id,				field_value				)				VALUES				(				UUID(),				#{projectId},				#{batchNo},				<if test="productDetailTableId == 'productdetail_buildingLease'">					'${fieldMap['productdetail_buildingLease_code']}',				</if>				<if test="productDetailTableId == 'productdetail_carParksCard'">					'${fieldMap['productdetail_carParksCard_code']}',				</if>				<if test="productDetailTableId == 'productdetail_fixedCarPark'">					'${fieldMap['productdetail_fixedCarPark_code']}',				</if>				<if test="productDetailTableId == 'productdetail_entranceGuardCard'">					'${fieldMap['productdetail_entranceGuardCard_code']}',				</if>				<if test="productDetailTableId == 'productdetail_decorationService'">					'${fieldMap['productdetail_decorationService_code']}',				</if>				<if test="productDetailTableId == 'productdetail_commonService'">					'${fieldMap['productdetail_commonService_code']}',				</if>				#{k},				'${fieldMap[k]}'				)			</foreach>		</foreach>	</insert>	<!-- 编辑产品明细 -->	<update id="modifyProductDetail" parameterType="TProductDetailModify">		<foreach collection="fieldMap.keys" item="k" separator=";">			UPDATE t_product_detail SET field_value = '${fieldMap[k]}' WHERE field_id = #{k} AND project_id = #{projectId} AND batch_no = #{batchNo} AND code = #{code}		</foreach>	</update>	<!-- 根据产品编号删除产品明细 -->	<delete id="deleteProductDetailByProductCode" parameterType="String">		INSERT INTO t_product_detail_history(id,project_id,batch_no,code,field_id,field_value) SELECT id,project_id,batch_no,code,field_id,field_value FROM t_product_detail WHERE project_id = #{0} AND batch_no = #{1} AND code = #{2};		DELETE FROM t_product_detail WHERE project_id = #{0} AND batch_no = #{1} AND code = #{2};		DELETE FROM t_product_attachment WHERE project_id = #{0} AND batch_no = #{1} AND product_code = #{2};	</delete></mapper>