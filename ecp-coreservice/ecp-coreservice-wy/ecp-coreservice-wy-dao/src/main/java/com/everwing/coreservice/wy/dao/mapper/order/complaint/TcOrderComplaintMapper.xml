<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.everwing.coreservice.wy.dao.mapper.order.complaint.TcOrderComplaintMapper" > 	<resultMap type="TcOrderComplaint" id="BaseResultMap" >		<result property="id" column="id" jdbcType="VARCHAR"/>		<result property="orderCode" column="order_code" jdbcType="VARCHAR"/>		<result property="custName" column="cust_name" jdbcType="VARCHAR"/>		<result property="buildingCode" column="building_code" jdbcType="VARCHAR"/>		<result property="describer" column="describer" jdbcType="VARCHAR"/>		<result property="orderType" column="order_type" jdbcType="TINYINT"/>		<result property="orderTypeOne" column="order_type_one" jdbcType="TINYINT"/>		<result property="orderTypeTwo" column="order_type_two" jdbcType="TINYINT"/>		<result property="orderSource" column="order_source" jdbcType="TINYINT"/>		<result property="isVisit" column="is_visit" jdbcType="TINYINT"/>		<result property="orderStatus" column="order_status" jdbcType="TINYINT"/>		<result property="isUrgent" column="is_urgent" jdbcType="TINYINT"/>		<result property="chargePersonId" column="charge_person_id" jdbcType="VARCHAR"/>		<result property="completeOrderId" column="complete_order_id" jdbcType="VARCHAR"/>		<result property="relationId" column="relation_id" jdbcType="VARCHAR"/>		<result property="createId" column="create_id" jdbcType="VARCHAR"/>		<result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>		<result property="modifyId" column="modify_id" jdbcType="VARCHAR"/>		<result property="modifyTime" column="modify_time" jdbcType="TIMESTAMP"/>		<result property="projectId" column="project_id" jdbcType="VARCHAR"/>		<result property="projectName" column="project_name" jdbcType="VARCHAR"/>	</resultMap>  	  	<select id="findById" resultMap="BaseResultMap" parameterType="String">  		select * from tc_order_complaint where id = #{0}  	</select>		<select id="findByObj" resultMap="BaseResultMap" parameterType="TcOrderComplaint">			select t1.id,	  			   t1.order_code,	  			   t1.cust_name,	  			   t1.building_code,	  			   t1.describer,	  			   t1.order_type,	  			   t1.order_type_one,	  			   t1.order_type_two,	  			   t1.order_source,	  			   t1.is_visit,	  			   t1.relation_id,	  			   (t1.order_status*1) as order_status,				   t1.is_urgent,	  			   t1.charge_person_id,	  			   t1.complete_order_id,	  			   t1.create_id,	  			   t1.create_time,	  			   t1.modify_id,	  			   t1.modify_time,	  			   t1.project_id,	  			   t1.project_name	  	   from tc_order_complaint t1	  	   where 1 = 1 	  	   <if test="null != buildingCode">	  	   	   and t1.building_code = #{buildingCode}	  	   </if>	  	   <if test="null != orderType">	  	   		and t1.order_type = #{orderType}	  	   </if>		   <if test="null != orderTypeOne">		   		and t1.order_type_one = #{orderTypeOne}		   </if>  		   <if test="null != orderTypeTwo">		   		and t1.order_type_two = #{orderTypeTwo}		   </if>		   <if test="null != orderStatus">		   		and t1.order_status = #{orderStatus}		   </if>			   <if test="null != custName">		   		and t1.cust_name like CONCAT('%',#{custName},'%')		   </if>		   <if test="projectId !=null and projectId !=''">		   	    and t1.project_id=#{projectId}		   </if>		   <if test="projectName !=null and projectName !=''">		   		and t1.project_name=#{projectName}		   </if>		   <if test="null != createTime">		   		<![CDATA[			   		and DATE_FORMAT(t1.create_time,'%Y-%m') = #{createTime}		   		]]>		   </if>	</select>	    	<select id="listPage" resultMap="BaseResultMap" parameterType="TcOrderComplaint">  		select t1.id,  			   t1.order_code,  			   t1.cust_name,  			   t1.building_code,  			   t1.describer,  			   t1.order_type,  			   t1.order_type_one,  			   t1.order_type_two,  			   t1.order_source,  			   t1.is_visit,  			   t1.relation_id,  			   (t1.order_status*1) as order_status,			   t1.is_urgent,  			   t2.staff_name as charge_person_id,  			   t1.complete_order_id,  			   t1.create_id,  			   t1.create_time,  			   t1.modify_id,  			   t1.modify_time,  			   t1.project_id,	  		   t1.project_name  	   from tc_order_complaint t1,  	   	    t_sys_user t2  	   where t1.charge_person_id = t2.user_id  	   <if test="null != describer">  	   		and t1.describer like CONCAT('%',#{describer},'%')  	   </if>  	   <if test="null != orderType">  	   		and t1.order_type = #{orderType}  	   </if>	   <if test="null != orderTypeOne">	   		and t1.order_type_one = #{orderTypeOne}	   </if>  	   <if test="null != orderTypeTwo">	   		and t1.order_type_two = #{orderTypeTwo}	   </if>	   <if test="null != orderStatus">	   		and t1.order_status = #{orderStatus}	   </if>		   <if test="null != custName">	   		and t1.cust_name like CONCAT('%',#{custName},'%')	   </if>	 <if test="projectId !=null and projectId !=''">		   	    and t1.project_id=#{projectId}	  </if>	  <if test="projectName !=null and projectName !=''">		   		and t1.project_name=#{projectName}	  </if>	  <if test="null != createTime">	   		<![CDATA[		   		and DATE_FORMAT(t1.create_time,'%Y-%m') = #{createTime}	   		]]>	   </if>	   <if test="null != searchContent">			and (					t1.describer like CONCAT('%',#{searchContent},'%')				or					t1.order_type = #{searchContent}				or					t1.order_type_one = #{searchContent}				or					t1.order_type_two = #{searchContent}				or					t1.order_status = #{searchContent}				or					t2.staff_name like CONCAT('%',#{searchContent},'%')				or					t1.cust_name like CONCAT('%',#{searchContent},'%')				or					t1.building_code in (select building_code 										   from tc_building 										  where building_full_name like CONCAT('%',#{searchContent},'%') 										  group by building_code										 )			)	   			   </if>  	</select>  	  	<insert id="insert" parameterType="TcOrderComplaint">  		insert into tc_order_complaint  		(  			id,  			order_code,  			cust_name,  			building_code,  			describer,  			order_type,  			order_type_one,  			order_type_two,  			order_source,  			is_visit,  			order_status,  			is_urgent,  			charge_person_id,  			complete_order_id,  			relation_id,  			create_id,  			create_time,  			modify_id,  			modify_time,  			project_id,  			project_name  		)  		values  		(  			UPPER(UUID()),  			(select * from (			  				SELECT CONCAT("TS",LPAD(IFNULL(SUBSTRING(MAX(order_code),5),"00001")+1,5,"0")) 			  				FROM tc_order_complaint 			  				ORDER BY order_code DESC 			  				LIMIT 0,1			  				) t  			),  			#{custName},  			#{buildingCode},  			#{describer},  			#{orderType},  			#{orderTypeOne},  			#{orderTypeTwo},  			#{orderSource},  			#{isVisit},  			#{orderStatus},  			#{isUrgent},  			#{chargePersonId},  			#{completeOrderId},  			#{relationId},  			#{createId},  			sysdate(),  			#{createId},  			sysdate(),  			#{projectId},  			#{projectName}  		)  	</insert>  	  	<update id="update" parameterType="TcOrderComplaint">  		update tc_order_complaint  		<set>  			<if test="null != custName">  				cust_name = #{custName},  			</if>  			<if test="null != describer">  				describer = #{describer},  			</if>  			<if test="null != buildingCode">  				building_code = #{buildingCode},  			</if>  			<if test="null != orderType">  				order_type = #{orderType},  			</if>  			<if test="null != orderTypeOne">  				order_type_one = #{orderTypeOne},  			</if>  			<if test="null != orderTypeTwo">  				order_type_two = #{orderTypeTwo},  			</if>  			<if test="null != orderSource">  				order_source = #{orderSource},  			</if>  			<if test="null != isVisit">  				is_visit = #{isVisit},  			</if>  			<if test="null != orderStatus">  				order_status = #{orderStatus},  			</if>  			<if test="null != isUrgent">  				is_urgent = #{isUrgent},  			</if>  			<if test="null != chargePersonId">  				charge_person_id = #{chargePersonId},  			</if>  			<if test="null != completeOrderId">  				complete_order_id = #{completeOrderId},  			</if>  			<if test="null != relationId">  				relation_id = #{relationId},  			</if>  			<if test="null != modifyId">  				modify_id = #{modifyId},  			</if>	  			<if test="null != projectId">  				project_id=#{projectId},  			</if>  			<if test="null != projectName">  				project_name=#{projectName},  			</if>  			modify_time = sysdate()  		</set>  		where id = #{id}  	</update>  <!--  根据类型(水电表)，buildCode、create_time和项目来查询 主要是做资产变更-->  <select id="findByTypeAndBuildCode" parameterType="String" resultMap="BaseResultMap">  	 select * from tc_order_complaint   	 where project_id=#{3}  	 and DATE_FORMAT(create_time,'%Y-%m-%D') = DATE_FORMAT(#{2},'%Y-%m-%D')  	 and building_code=#{1}  	 and order_type_one=#{0}  	 and order_type_two=1  	 and order_type=1  	 ORDER BY create_time DESC  	 LIMIT 0,1   </select>    <resultMap type="java.util.Map" id="detailResultMap">  		<result column="id" property="id"/>  		<result column="order_code" property="orderCode"/>  		<result column="cust_name" property="custName"/>  		<result column="fullName" property="fullName"/>  		<result column="describer" property="describer"/>  		<result column="order_status" property="orderStatus"/>  		<result column="is_urgent" property="isUrgent"/>  		<result column="staffName" property="staffName"/>  </resultMap>  <!--根据工单号查询工单 -->  <select id="findByOrderCode" parameterType="java.lang.String" resultMap="detailResultMap">	  select 	     t1.id,		 t1.order_code, 		 t1.cust_name,		 (SELECT ta1.building_full_name FROM tc_building ta1 WHERE ta1.building_code=t1.building_code and ta1.project_id=#{0}) AS fullName,		 t1.describer,		 t1.order_status*1 as order_status,		 t1.is_urgent*1 as is_urgent,		 (SELECT tuser.staff_name from t_sys_user tuser where tuser.user_id=t1.charge_person_id) as staffName	 from tc_order_complaint t1	 where t1.project_id=#{0}	 and (t1.order_code=#{1} or t1.id=#{1})  </select>    <resultMap type="java.util.Map" id="detailMeterDataMap">  		<result column="meter_code" property="meterCode"/>  		<result column="audit_status" property="auditStatus"/>  		<result column="status" property="status"/>  		<result column="id" property="id"/>  		<result column="last_common_reading" property="lastCommonReading"/>  		<result column="last_peak_reading" property="lastPeakReading"/>  		<result column="last_total_reading" property="lastTotalReading"/>  		<result column="last_vally_reading" property="lastVallyReading"/>  		<result column="total_reading" property="totalReading"/>  		<result column="common_reading" property="commonReading"/>  		<result column="vally_reading" property="vallyReading"/>  		<result column="peak_reading" property="peakReading"/>  		<result column="create_time" property="createTime"/>  		<result column="last_task_id" property="lastTaskId"/>  		<result column="reading_time" property="readingTime"/>  </resultMap>    <!-- 根据buildCode和meter_type查找最新的两条数据；因为可能有重抄表的情况，所以找最新两期数据 -->  <select id="findByBuildAndMeterType" parameterType="java.lang.String" resultMap="detailMeterDataMap">		SELECT			meda.meter_code,		  task.audit_status*1 as audit_status,		  task.status*1 as status,		  task.id,		  task.create_time,		  task.last_task_id,		  meda.last_common_reading,		  meda.last_peak_reading,		  meda.last_total_reading,		  meda.last_vally_reading,		  meda.total_reading,		  meda.common_reading,		  meda.vally_reading,		  meda.peak_reading,		  meda.reading_time		FROM			tc_reading_task task,			tc_meterfeeobj_relation rea,			tc_meter_data meda		where task.id = rea.relation_id		and task.id=meda.task_id		and rea.building_code=#{1}		and task.meter_type=#{2}		and meda.project_id=#{0}		order by  task.create_time desc 		LIMIT 0,2  </select>    <select id="findbyBuildCodeAndProjectId" parameterType="java.lang.String" resultMap="BaseResultMap">  	select * from tc_order_complaint where project_id=#{0} and building_code=#{1} and order_status != 2 and order_type= 0  </select>    <!-- 根据orderCode和projectId查询 -->  <select id="findTcOrderByOrderCode" parameterType="String" resultType="TcOrderComplaint">   select  * from tc_order_complaint where project_id=#{0} and order_code=#{1}  </select></mapper>