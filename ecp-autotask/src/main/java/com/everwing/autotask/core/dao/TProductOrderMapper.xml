<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.everwing.autotask.core.dao.TProductOrderMapper">	<resultMap id="BaseResultMap" type="TProductOrder">		<result property="id" column="id"/>		<result property="projectId" column="project_id"/>		<result property="batchNo" column="batch_no"/>		<result property="productType" column="product_type"/>		<result property="productName" column="product_name"/>		<result property="buyerId" column="buyer_id"/>		<result property="totalPrice" column="total_price"/>		<result property="discountPrice" column="discount_price"/>		<result property="status" column="status"/>		<result property="version" column="version"/>		<result property="createrId" column="creater_id"/>		<result property="createrName" column="creater_name"/>		<result property="modifyId" column="modify_id"/>		<result property="modifyName" column="modify_name"/>		<result property="createTime" column="create_time"/>		<result property="modifyTime" column="modify_time"/>	</resultMap>	<resultMap id="ListResultMap" type="TProductOrderList" extends="BaseResultMap">		<result property="statusName" column="status_name"/>		<result property="buyerName" column="buyer_name"/>	</resultMap>	<select id="listPage" parameterType="TProductOrderSearch" resultMap="ListResultMap">		SELECT			po.*,			(				CASE WHEN (SELECT count(*) FROM tc_person_cust pc WHERE pc.cust_id = po.buyer_id) > 0 THEN					(SELECT pc1.`name` FROM tc_person_cust pc1 WHERE pc1.cust_id = po.buyer_id)				ELSE					(SELECT ec.enterprise_name FROM tc_enterprise_cust ec WHERE ec.enterprise_id = po.buyer_id)				END			)AS buyer_name		FROM t_product_order po where 1=1		<if test="projectId != null and projectId != ''">			AND po.project_id = #{projectId}		</if>		<if test="productType != null and productType != ''">			AND po.product_type = #{productType}		</if>		<if test="searchKeyWord != null and searchKeyWord != ''">			AND (po.batch_no = #{searchKeyWord} OR po.product_name LIKE CONCAT('%',trim(#{searchKeyWord}),'%') OR po.buyer_id =#{buyerId} OR po.creater_name LIKE CONCAT('%',trim(#{searchKeyWord}),'%'))		</if>		<if test="batchNo != null and batchNo != ''">			AND po.batch_no = trim(#{batchNo})		</if>		<if test="productName != null and productName != ''">			AND po.product_name = trim(#{productName})		</if>		<if test="buyerId != null and buyerId != ''">			AND po.buyer_id = #{buyerId}		</if>		<if test="status != null and status != ''">			AND po.status = #{status}		</if>		<if test="beginTime != null and beginTime != ''">			<![CDATA[ AND DATE_FORMAT(po.create_time, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d')]]>		</if>		<if test="endTime != null and endTime != ''">			<![CDATA[ AND DATE_FORMAT(po.create_time, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d')]]>		</if>		<if test="createrName != null and createrName != ''">			AND po.creater_name = trim(#{createrName})		</if>		ORDER BY po.batch_no DESC	</select>	<select id="findByCondition" parameterType="TProductOrderSearch" resultMap="ListResultMap">		select * from t_product_order po where 1=1		<if test="id != null and id != ''">			AND po.id = #{id}		</if>		<if test="projectId != null and projectId != ''">			AND po.project_id = #{projectId}		</if>		<if test="batchNo != null and batchNo != ''">			AND po.batch_no = trim(#{batchNo})		</if>		<if test="productType != null and productType != ''">			AND po.product_type = #{productType}		</if>		<if test="productName != null and productName != ''">			AND po.product_name = trim(#{productName})		</if>		<if test="status != null and status != ''">			AND po.status = #{status}		</if>		<if test="statusList != null">			AND po.status IN			<foreach collection="statusList" item="item" index="index" open="(" close=")" separator=",">				'${item}'			</foreach>		</if>		<if test="createrId != null and createrId != ''">			AND po.creater_id = #{createrId}		</if>		<if test="version != null and version != ''">			AND po.version = #{version}		</if>	</select>	<!-- 产品收款汇总报表 -->	<select id="productCollectingReports" parameterType="TProductOrderSearch" resultType="java.util.Map">		SELECT		t1.product_name,		SUM(t1.order_amount) AS total_price		FROM		(			SELECT				po.project_id,				po.product_type,				po.product_name AS product_type_name,				pod.product_name AS product_name,				pod.order_amount			FROM t_product_order po,t_product_order_detail pod			WHERE po.id = pod.order_id				AND po.project_id = #{projectId}				AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &gt;=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d')				AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &lt;=  DATE_FORMAT(#{endTime}, '%Y-%m-%d')				AND po.`status` = 'success'				<if test="buyerId != null and buyerId != ''">					AND po.buyer_id = #{buyerId}				</if>				<if test="productType != null and productType != ''">					AND po.product_type = #{productType}				</if>				<if test="createrName != null and createrName != ''">					AND po.creater_name = trim(#{createrName})				</if>		)t1		GROUP BY t1.product_name		UNION		SELECT			'折扣小计' AS product_name,			SUM(po.discount_price) AS total_price		FROM			t_product_order po		WHERE 1=1			AND po.project_id = #{projectId}			AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &gt;=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d')			AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &lt;=  DATE_FORMAT(#{endTime}, '%Y-%m-%d')			AND po.`status` = 'success'			<if test="buyerId != null and buyerId != ''">				AND po.buyer_id = #{buyerId}			</if>			<if test="productType != null and productType != ''">				AND po.product_type = #{productType}			</if>			<if test="createrName != null and createrName != ''">				AND po.creater_name = trim(#{createrName})			</if>	</select>	<!-- 产品收款流水报表 -->	<select id="productCollectingSerialNumberReports" parameterType="TProductOrderSearch" resultType="java.util.Map">		SELECT			po.id,			po.batch_no,			po.create_time,			pod.product_name,			(SELECT b.house_code FROM tc_building b WHERE b.building_code = pod.building_code) AS house_code,			(SELECT b.building_full_name  FROM tc_building b WHERE b.building_code = pod.building_code) AS building_full_name,			pod.order_amount AS total_price,			po.creater_name,			(SELECT GROUP_CONCAT(p.pay_type) AS pay_type FROM t_product_payment_detail p WHERE p.order_id = po.id) AS pay_type		FROM			t_product_order po,			t_product_order_detail pod		WHERE 1=1		AND po.id = pod.order_id		AND po.project_id = #{projectId}		AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &gt;=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d')		AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &lt;=  DATE_FORMAT(#{endTime}, '%Y-%m-%d')		AND po.`status` = 'success'		<if test="productType != null and productType != ''">			AND po.product_type = #{productType}		</if>		<if test="createrName != null and createrName != ''">			AND po.creater_name = trim(#{createrName})		</if>		ORDER BY		po.product_name ASC	</select>	<!-- 产品收款方式汇总报表 -->	<select id="productPayTypeReports" parameterType="TProductOrderSearch" resultType="java.util.Map">		select			sum(case source.pay_type when 'charge' then source.sum_price else 0 end)  charge,			sum(case source.pay_type when 'bank' then source.sum_price else 0 end)  bank,			sum(case source.pay_type when 'cash' then source.sum_price else 0 end)  cash,			sum(case source.pay_type when 'weixinpay' then source.sum_price else 0 end)  weixinpay,			sum(case source.pay_type when 'alipay' then source.sum_price else 0 end)  alipay		from (			SELECT				ppd.pay_type pay_type,				SUM(ppd.price) sum_price			FROM			t_product_order po,			t_product_payment_detail ppd			WHERE 1=1			AND po.id = ppd.order_id			AND po.`status` = 'success'			AND po.project_id = #{projectId}			AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &gt;=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d')			AND DATE_FORMAT(po.create_time, '%Y-%m-%d') &lt;=  DATE_FORMAT(#{endTime}, '%Y-%m-%d')			<if test="buyerId != null and buyerId != ''">				AND po.buyer_id = #{buyerId}			</if>			<if test="productType != null and productType != ''">				AND po.product_type = #{productType}			</if>			<if test="createrName != null and createrName != ''">				AND po.creater_name = trim(#{createrName})			</if>			group by ppd.pay_type		) source	</select>	<insert id="batchInsert" parameterType="List">		INSERT INTO t_product_order		(			id,			project_id,			batch_no,			product_type,			product_name,			buyer_id,			total_price,			discount_price,			status,		    version,			creater_id,			creater_name,			create_time		)		VALUES		<foreach collection="list" index="index" item="item" separator=",">		(			#{item.id},			#{item.projectId},			#{item.batchNo},			#{item.productType},			#{item.productName},			#{item.buyerId},			#{item.totalPrice},			#{item.discountPrice},			#{item.status},			1,			#{item.createrId},			#{item.createrName},			sysdate()		)		</foreach>	</insert>	<!-- 推送财务数据时根据条件查询(调整为拿财务审核通过的数据) -->	<select id="getProductInfos" parameterType="java.util.Map" resultType="java.util.Map">				SELECT			t1.create_time createTime,			t1.product_type productType,			t1.product_name productTypeName,			t1.project_id projectId,			t1.batch_no batchNo,			t1.total_price totalPrice,			t1.discount_price discountPrice,			t2.order_id orderId,			t2.product_common productCommon,			t2.product_name productName,			t2.quantity,			t2.order_amount orderAmount,			t3.total_amount totalAmount,			t4.pay_type payType		FROM			(				SELECT					*				FROM					t_product_order				WHERE					project_id = (						SELECT							project_id						FROM							t_sys_project						WHERE							CODE = #{projectId}					)				AND STATUS = 'success'				AND batch_no in (							SELECT relation_id FROM t_jg_account_receivable WHERE total_id IN (						SELECT id FROM t_jg_total_calculation WHERE total_id IN (					     SELECT id FROM t_jg_total_calculation WHERE total_id IN (									SELECT id FROM t_jg_total_calculation WHERE receive_id IN (											SELECT user_id FROM t_jg_staff_grop WHERE project_id = #{projectId} AND role_level = 1									) ) AND STATUS = 3									AND project_id = #{projectId} )							AND STATUS = 3							AND project_id = #{projectId}						) AND business_type in (2,3) 						<if test=" null != lastPushDate and '' != lastPushDate ">							<![CDATA[								AND create_time > #{lastPushDate} 							]]>						</if>						<if test=" null != intervalDays and '' != intervalDays ">							<![CDATA[								AND create_time < #{intervalDays} 							]]>						</if>				)			) t1		LEFT JOIN (			SELECT				*			FROM				t_product_order_detail			WHERE				order_id IN (					SELECT						id					FROM						t_product_order					WHERE						project_id = (							SELECT								project_id							FROM								t_sys_project							WHERE								CODE = #{projectId}						)					AND STATUS = 'success'				)		) t2 ON t1.id = t2.order_id		LEFT JOIN t_deposit t3 ON t1.batch_no = t3.order_batch_no		AND t3. STATUS = 'done'		LEFT JOIN t_product_payment_detail t4 ON t1.id = t4.order_id	</select>	<update id="modify" parameterType="TProductOrder">		UPDATE t_product_order SET		discount_price = #{discountPrice},		status = #{status},		version = version + 1,		modify_id = #{modifyId},		modify_name = #{modifyName},		modify_time = sysdate()		WHERE (id = #{id} OR batch_no = #{batchNo})		AND version = #{version}	</update></mapper>