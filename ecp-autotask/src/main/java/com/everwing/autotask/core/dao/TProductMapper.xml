<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" ><mapper namespace="com.everwing.autotask.core.dao.TProductMapper">	<!-- 产品详细 S -->	<resultMap id="TProductDetailResultMap" type="TProductDetail">		<result property="projectId" column="project_id"/>		<result property="batchNo" column="batch_no"/>		<result property="code" column="code"/>		<result property="fieldId" column="field_id"/>		<result property="fieldValue" column="field_value"/>	</resultMap>	<resultMap id="DetailListResultMap" type="TProductDetailList" extends="TProductDetailResultMap">		<result property="fieldName" column="field_name"/>		<result property="attachmentKey" column="attachment_key"/>		<result property="buildingArea" column="building_area"/>		<result property="usableArea" column="usable_area"/>	</resultMap>	<!-- 根据条件查询产品详细 -->	<select id="findProductDetailByCondition" resultMap="DetailListResultMap" parameterType="TProductDetailSearch">		SELECT			t.*		FROM		(			SELECT				p.project_id,				p.batch_no,				p.`code`,				p.field_id,				f.field_name,				p.field_value,				f.order_index,				(SELECT b.building_area FROM tc_building b WHERE b.house_code_new = p.field_value)AS building_area,				(SELECT b.usable_area FROM tc_building b WHERE b.house_code_new = p.field_value) AS usable_area			FROM				t_product_detail p,				t_fields f			WHERE				p.field_id = f.id		) t WHERE 1=1		<if test="projectId != null and projectId != ''">			AND t.project_id = #{projectId}		</if>		<if test="batchNo != null and batchNo != ''">			AND t.batch_no = #{batchNo}		</if>		<if test="code != null and code != ''">			AND t.code = #{code}		</if>		<if test="fieldId != null and fieldId != ''">			AND t.field_id = #{fieldId}		</if>		<if test="fieldValue != null and fieldValue != ''">			AND t.batch_no IN			(				SELECT					pd.batch_no				FROM t_product_detail pd				WHERE pd.field_id IN(SELECT f.id FROM t_fields f WHERE f.table_id = #{productDetailTableId})				AND pd.field_value LIKE CONCAT('%',#{fieldValue},'%')			)		</if>		<if test="productCodeList != null">			AND t.code IN			<foreach collection="productCodeList" item="item" index="index" open="(" close=")" separator=",">				'${item}'			</foreach>		</if>		ORDER BY			t.project_id,			t.batch_no,			t.`code`,			t.order_index	</select>	<!-- 编辑产品明细 -->	<update id="modifyProductDetail" parameterType="TProductDetailModify">		<foreach collection="fieldMap.keys" item="k" separator=";">			UPDATE t_product_detail SET field_value = '${fieldMap[k]}' WHERE field_id = #{k} AND project_id = #{projectId} AND batch_no = #{batchNo} AND code = #{code}		</foreach>	</update></mapper>